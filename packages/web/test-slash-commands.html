<!doctype html>
<html>
  <head>
    <title>Plate.js v49 Slash Commands Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .editor {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 200px;
      }
      .menu {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Plate.js v49 Slash Commands Debug</h1>

    <h2>Key Issues Identified:</h2>
    <ol>
      <li>
        <strong>Selection Management:</strong> The slash command menu loses
        editor focus
      </li>
      <li>
        <strong>Type Mapping:</strong> Block types need to match plugin
        configuration
      </li>
      <li>
        <strong>Timing Issues:</strong> Command execution happens before slash
        cleanup
      </li>
      <li>
        <strong>Error Handling:</strong> Missing try-catch for transform
        operations
      </li>
    </ol>

    <h2>Working Solutions:</h2>
    <ol>
      <li>
        <strong>Save Selection:</strong> Store editor selection before opening
        menu
      </li>
      <li>
        <strong>Restore Focus:</strong> Restore editor focus before executing
        commands
      </li>
      <li>
        <strong>Clean Slash:</strong> Remove slash character before
        transformation
      </li>
      <li>
        <strong>Guard Conditions:</strong> Check editor.selection exists before
        transforms
      </li>
    </ol>

    <h2>Proper Slash Command Pattern:</h2>
    <pre><code>
// 1. Save selection when opening menu
const openMenu = useCallback((pos) => {
  setSavedSelection(editor.selection)
  setIsOpen(true)
}, [editor])

// 2. Restore state and execute command
const handleCommandSelect = useCallback((command) => {
  try {
    // Restore focus and selection
    editor.focus()
    if (!editor.selection && savedSelection) {
      editor.select(savedSelection)
    }
    
    // Clean up slash character
    if (editor.selection) {
      editor.tf.delete({
        at: {
          anchor: { path: currentPath, offset: currentOffset - 1 },
          focus: { path: currentPath, offset: currentOffset }
        }
      })
    }
    
    // Execute transformation
    if (editor.selection) {
      editor.tf.setNodes({ type: 'h1' })
    }
  } catch (error) {
    console.error('Command failed:', error)
  }
}, [editor, savedSelection])
    </code></pre>

    <h2>E2E Test Fixes Needed:</h2>
    <ul>
      <li>Add proper data-testid attributes to menu</li>
      <li>Wait for editor focus after command selection</li>
      <li>Use correct CSS selectors (.slash-command-menu)</li>
      <li>Handle async transformation completion</li>
    </ul>
  </body>
</html>
